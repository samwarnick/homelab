---
- name: Harden Ubuntu Server
  hosts: all
  become: true
  gather_facts: false

  tasks:
    - name: Wait for system to become reachable
      wait_for_connection:
        timeout: 120
        delay: 5

    - name: Gather facts after connection is established
      setup:

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Upgrade all packages
      apt:
        upgrade: dist

    - name: Create new user
      user:
        name: "{{ new_user }}"
        shell: /bin/bash
        groups: sudo
        append: yes
        create_home: yes

    - name: Set up authorized keys for new user
      authorized_key:
        user: "{{ new_user }}"
        key: "{{ lookup('file', lookup('env', 'HOME') + '/.ssh/id_rsa.pub') }}"

    - name: Allow sudo without password for new user
      lineinfile:
        path: /etc/sudoers.d/{{ new_user }}
        line: "{{ new_user }} ALL=(ALL) NOPASSWD:ALL"
        create: yes
        mode: "0440"

    - name: Install required packages
      apt:
        name:
          - ufw
          - fail2ban
          - unattended-upgrades
          - apt-listchanges
        state: present

    - name: Configure UFW defaults
      ufw:
        direction: "{{ item.direction }}"
        policy: "{{ item.policy }}"
      loop:
        - { direction: "incoming", policy: "deny" }
        - { direction: "outgoing", policy: "allow" }

    - name: Allow SSH through UFW
      ufw:
        rule: allow
        port: "{{ ssh_port }}"
        proto: tcp
        from_ip: "{{ item }}"
      loop: "{{ allowed_networks_ssh }}"

    - name: Enable UFW
      ufw:
        state: enabled

    - name: Configure fail2ban
      copy:
        dest: /etc/fail2ban/jail.local
        content: |
          [DEFAULT]
          bantime = 3600
          findtime = 600
          maxretry = 5

          [sshd]
          enabled = true
          port = {{ ssh_port }}

    - name: Start and enable fail2ban
      systemd:
        name: fail2ban
        state: started
        enabled: yes

    - name: Verify new user SSH access
      ansible.builtin.ping:
      become: false
      remote_user: "{{ new_user }}"

    - name: Enable root SSH login
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^#?PermitRootLogin"
        line: "PermitRootLogin prohibit-password"
      notify: restart ssh

    - name: Enable SSH public key authentication
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^#?PubkeyAuthentication"
        line: "PubkeyAuthentication yes"
        state: present
      notify: restart ssh

    - name: Remove cloud-init restrictions from root authorized_keys
      lineinfile:
        path: /root/.ssh/authorized_keys
        regexp: '^no-port-forwarding,no-agent-forwarding,no-X11-forwarding,command="echo.*exit 142" '
        state: absent

    - name: Disable password authentication
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^#?PasswordAuthentication"
        line: "PasswordAuthentication no"
      notify: restart ssh

    - name: Disable empty passwords
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^#?PermitEmptyPasswords"
        line: "PermitEmptyPasswords no"
      notify: restart ssh

    - name: Configure automatic security updates
      copy:
        dest: /etc/apt/apt.conf.d/50unattended-upgrades
        content: |
          Unattended-Upgrade::Allowed-Origins {
              "${distro_id}:${distro_codename}-security";
          };
          Unattended-Upgrade::Automatic-Reboot "false";
          Unattended-Upgrade::Remove-Unused-Dependencies "true";

    - name: Enable automatic updates
      copy:
        dest: /etc/apt/apt.conf.d/20auto-upgrades
        content: |
          APT::Periodic::Update-Package-Lists "1";
          APT::Periodic::Download-Upgradeable-Packages "1";
          APT::Periodic::AutocleanInterval "7";
          APT::Periodic::Unattended-Upgrade "1";

    - name: Remove snapd
      apt:
        name: snapd
        state: absent
        purge: yes

    - name: Set proper timezone
      timezone:
        name: "{{ timezone }}"

    - name: Set up Cloudflare Tunnel
      include_tasks: tasks/cloudflared.yml
      when: cloudflare_tunnel_token is defined

    - name: Setup app data directory
      file:
        path: "{{ app_data_path }}"
        state: directory
        owner: "{{ new_user }}"
        group: "{{ new_user }}"
        mode: "0755"
      when: app_data_path is defined

  handlers:
    - name: restart ssh
      systemd:
        name: ssh
        state: restarted
    - name: reload ufw
      community.general.ufw:
        state: reloaded
    - name: reload exports
      command: exportfs -ra
